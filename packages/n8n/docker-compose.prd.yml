# n8n production services - import only, no auto-export

x-n8n-env: &n8n-env
  DB_TYPE: postgresdb
  DB_POSTGRESDB_HOST: postgres
  DB_POSTGRESDB_PORT: 5432
  DB_POSTGRESDB_DATABASE: ${POSTGRES_DB:-app_db}
  DB_POSTGRESDB_USER: ${POSTGRES_USER:-dbuser}
  DB_POSTGRESDB_PASSWORD: ${POSTGRES_PASSWORD:?POSTGRES_PASSWORD is required}
  N8N_ENCRYPTION_KEY: ${N8N_ENCRYPTION_KEY:?N8N_ENCRYPTION_KEY is required}
  EXECUTIONS_MODE: queue
  QUEUE_BULL_REDIS_HOST: ${REDIS_HOST:-redis}
  QUEUE_BULL_REDIS_PORT: ${REDIS_PORT:-6379}
  GENERIC_TIMEZONE: ${TZ:-UTC}
  TZ: ${TZ:-UTC}
  N8N_BLOCK_ENV_ACCESS_IN_NODE: "false"

# credential env vars for manifest.yml bootstrap
x-n8n-credential-yaml-file: &n8n-credential-yaml-file
  TEST_HEADER_NAME: ${TEST_HEADER_NAME:-X-API-Key}
  TEST_HEADER_VALUE: ${TEST_HEADER_VALUE:-test-secret-key-12345}

services:
  n8n:
    image: n8nio/n8n:2.3.5
    container_name: n8n
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    env_file:
      - ../../.env
    environment:
      <<: *n8n-env
      N8N_HOST: ${N8N_HOST:-localhost}
      N8N_PORT: 5678
      N8N_PROTOCOL: ${N8N_PROTOCOL:-http}
      WEBHOOK_URL: ${WEBHOOK_URL:-http://localhost:5678/}
      N8N_DIAGNOSTICS_ENABLED: "false"
      N8N_PERSONALIZATION_ENABLED: "false"
    ports:
      - "5678:5678"
    volumes:
      - n8n_data:/home/node/.n8n
      - ./workflows:/workflows:ro
      - ./credentials:/credentials:ro
    extra_hosts:
      - "host.docker.internal:host-gateway"
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "wget -q --spider http://localhost:5678/healthz || exit 1",
        ]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s

  n8n-worker:
    image: n8nio/n8n:2.3.5
    container_name: n8n-worker
    restart: unless-stopped
    command: worker
    deploy:
      replicas: 1
    depends_on:
      n8n:
        condition: service_healthy
      redis:
        condition: service_healthy
    env_file:
      - ../../.env
    environment:
      <<: *n8n-env
    volumes:
      - n8n_data:/home/node/.n8n

  n8n-init:
    build: ./init
    container_name: n8n-init
    depends_on:
      n8n:
        condition: service_healthy
    env_file:
      - ../../.env
    environment:
      <<: [*n8n-env, *n8n-credential-yaml-file]
      N8N_OWNER_EMAIL: ${N8N_OWNER_EMAIL:-admin@admin.local}
      N8N_OWNER_PASSWORD: ${N8N_OWNER_PASSWORD:-password}
    volumes:
      - ./workflows:/workflows:ro
      - ./credentials:/credentials:ro
      - ./community-nodes.txt:/community-nodes/community-nodes.txt:ro
